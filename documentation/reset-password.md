
# 📄 تحلیل جامع و کامل – صفحه `reset-password.html` (تنظیم رمز عبور جدید)

---

## 🎯 ۱. هدف اصلی صفحه
- **تنظیم رمز عبور جدید**: امکان تغییر رمز عبور برای کاربران پس از دریافت لینک بازیابی.
- **اعتبارسنجی امنیتی**: اطمینان از اعتبار لینک بازیابی و رمز عبور جدید.
- **پیشگیری از حملات**: جلوگیری از حملات رایج (Token Reuse, Brute Force) با مکانیزم‌های امنیتی پیشرفته.

---

## 🏗️ ۲. ساختار کلی صفحه
```
┌────────────────────────────────────────────────────────────┐
│ 1️⃣ Header (لینک به صفحه اصلی و ورود)                      │
├────────────────────────────────────────────────────────────┤
│ 2️⃣ Hero Section (عنوان و توضیحات کوتاه)                   │
├────────────────────────────────────────────────────────────┤
│ 3️⃣ فرم تنظیم رمز عبور جدید                                │
│   ├── ورودی رمز عبور جدید (با قابلیت نمایش/مخفی)         │
│   ├── ورودی تأیید رمز عبور                                 │
│   ├── اندیکاتور قدرت رمز عبور                             │
│   ├── توکن امنیتی (مخفی)                                   │
│   └── دکمه ارسال                                           │
├────────────────────────────────────────────────────────────┤
│ ۴️⃣ پیام‌های وضعیت (Success/Error)                         │
├────────────────────────────────────────────────────────────┤
│ 5️⃣ Footer (لینک‌های مفید و حقوقی)                         │
└────────────────────────────────────────────────────────────┘
```

---

## ⚙️ ۳. تحلیل فنی

### 3.1. طراحی و UX
- **تم رنگی**: استفاده از رنگ‌های آبی (اعتماد) و سبز (موفقیت) با تأکید بر دکمه اصلی.
- **انیمیشن‌های ظریف**: برای بازخورد فوری در هنگام اعتبارسنجی.
- **اندیکاتور قدرت رمز عبور**: نمایش بصری قدرت رمز عبور (ضعیف/متوسط/قوی).
- **قابلیت نمایش/مخفی رمز عبور**: آیکون چشم برای هر دو فیلد رمز عبور.
- **بازخورد فوری**: 
  - تأییدیه تطابق رمزهای عبور در لحظه.
  - نمایش پیام‌های خطای واضح (مثلاً «رمزهای عبور مطابقت ندارند»).
- **ریسپانسیو**: طراحی برای تمامی دستگاه‌ها (موبایل، تبلت، دسکتاپ).

### 3.2. عملکردهای داینامیک (جاوااسکریپت)
| تابع | توضیح | تعامل کاربری |
|------|-------|-------------|
| `validatePassword(password)` | بررسی اعتبار رمز عبور بر اساس خط‌مشی | تایپ در فیلد رمز عبور |
| `checkPasswordMatch()` | بررسی تطابق رمز عبور و تأیید آن | تایپ در فیلد تأیید |
| `updateStrengthIndicator(password)` | به‌روزرسانی اندیکاتور قدرت رمز عبور | تایپ در فیلد رمز عبور |
| `togglePasswordVisibility(fieldId)` | نمایش/مخفی کردن رمز عبور | کلیک روی آیکون چشم |
| `handleSubmit()` | ارسال فرم به سرور | کلیک روی دکمه ارسال |
| `showMessage(type, message)` | نمایش پیام‌های وضعیت | دریافت پاسخ از سرور |
| `extractTokenFromURL()` | استخراج توکن از URL | لود صفحه |

### 3.3. امنیت
- **توکن امنیتی**:
  - استخراج از URL Query Parameter (`?token=abc123`).
  - ذخیره در فیلد مخفی یا متغیر جاوااسکریپت.
  - ارسال به سرور در هدر یا بدنه درخواست.
- **اعتبارسنجی توکن**:
  - بررسی اعتبار توکن در سمت سرور (وجود در دیتابیس، انقضا، استفاده نشده).
  - عدم امکان استفاده مجدد از توکن (One-Time Use).
- **خط‌مشی رمز عبور**:
  - حداقل ۸ کاراکتر
  - شامل حروف بزرگ و کوچک، عدد و کاراکتر خاص
  - عدم استفاده از اطلاعات شخصی (نام، ایمیل)
- **محدودیت درخواست‌ها**:
  - Rate Limiting (حداکثر ۳ درخواست در دقیقه برای یک IP).
  - مسدودسازی موقت پس از ۵ درخواست ناموفق.
- **امنیت فرم**:
  - جلوگیری از Autofill توسط مهاجمین (autocomplete="new-password").
  - استفاده از CSRF Token در درخواست‌های سرور.
- **رمزنگاری**:
  - ارسال درخواست از طریق HTTPS.
  - ذخیره‌سازی رمزهای جدید به صورت رمزنگاری‌شده (bcrypt/scrypt).

### 3.4. بک‌اند و دیتابیس
- **API Endpoint**:
  - `POST /api/auth/reset-password`  
    پارامترها: `token`, `newPassword`
- **دستگاه‌های ذخیره‌سازی**:
  - **Database**: جدول `password_reset_tokens` با ستون‌های:
    ```sql
    token_hash VARCHAR(255) PRIMARY KEY,
    user_id INT NOT NULL,
    expires_at DATETIME NOT NULL,
    used_at DATETIME NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    ```
  - **Users Table**: به‌روزرسانی ستون `password_hash` پس از تأیید توکن.
- **الگوریتم‌ها**:
  - `bcrypt` برای هش کردن رمز عبور (با salt خودکار).
  - `SHA-256` برای هش کردن توکن‌ها (قبل از ذخیره در دیتابیس).

---

## 📦 ۴. ساختار داده (API)

### 4.1. درخواست تنظیم رمز عبور
```json
{
  "token": "abc123def456", // توکن از URL
  "newPassword": "NewSecureP@ssw0rd!"
}
```

### 4.2. پاسخ موفق (200 OK)
```json
{
  "status": "success",
  "message": "رمز عبور شما با موفقیت تغییر یافت. اکنون می‌توانید وارد شوید.",
  "redirect": "/login"
}
```

### 4.3. پاسخ‌های خطا
```json
// 400 Bad Request: رمز عبور ضعیف
{
  "status": "error",
  "message": "رمز عبور باید حداقل ۸ کاراکتر داشته باشد و شامل حروف بزرگ، کوچک، عدد و کاراکتر خاص باشد."
}

// 401 Unauthorized: توکن نامعتبر
{
  "status": "error",
  "message": "لینک بازیابی نامعتبر یا منقضی شده است. لطفاً دوباره درخواست بازیابی رمز عبور دهید."
}

// 403 Forbidden: توکن استفاده شده
{
  "status": "error",
  "message": "این لینک بازیابی قبلاً استفاده شده است. لطفاً دوباره درخواست بازیابی رمز عبور دهید."
}

// 429 Too Many Requests: درخواست‌های بیش از حد
{
  "status": "error",
  "message": "تعداد درخواست‌های شما بیش از حد مجاز است. لطفاً بعداً تلاش کنید."
}
```

---

## 🎨 ۵. جزئیات طراحی UI

### 5.1. فرم اصلی
- **ورودی رمز عبور جدید**:
  - `type="password"` با قابلیت تغییر به `type="text"`
  - placeholder: "رمز عبور جدید"
  - آیکون چشم برای نمایش/مخفی کردن
- **ورودی تأیید رمز عبور**:
  - `type="password"` با قابلیت تغییر به `type="text"`
  - placeholder: "تأیید رمز عبور"
  - آیکون چشم برای نمایش/مخفی کردن
- **اندیکاتور قدرت رمز عبور**:
  - نوار پیشرفت رنگی (قرمز/زرد/سبز)
  - متن توضیحی (ضعیف/متوسط/قوی)
- **دکمه**:
  - متن: "تنظیم رمز عبور جدید"
  - حالت غیرفعال هنگام ارسال درخواست

### 5.2. پیام‌های وضعیت
- **موفق**:
  - پس‌زمینه سبز، آیکون تأیید (✓)، متن سبز.
- **خطا**:
  - پس‌زمینه قرمز، آیکون اخطار (⚠)، متن قرمز.
- **هشدار**:
  - پس‌زمینه زرد، متن سیاه (برای اخطارهای امنیتی).

### 5.3. اندیکاتور قدرت رمز عبور
```javascript
// الگوریتم سنجش قدرت رمز عبور
function calculatePasswordStrength(password) {
    let strength = 0;
    
    // طول رمز عبور
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    
    // پیچیدگی کاراکترها
    if (/[a-z]/.test(password)) strength += 1; // حروف کوچک
    if (/[A-Z]/.test(password)) strength += 1; // حروف بزرگ
    if (/[0-9]/.test(password)) strength += 1; // اعداد
    if (/[^A-Za-z0-9]/.test(password)) strength += 1; // کاراکترهای خاص
    
    // امتیاز نهایی
    if (strength <= 2) return 'ضعیف';
    if (strength <= 4) return 'متوسط';
    return 'قوی';
}
```

---

## 🚀 ۶. پیشنهادات توسعه‌ای

### 6.1. هوش مصنوعی
- **تشخیص رمزهای عبور ضعیف**: استفاده از یادگیری ماشین برای شناسایی الگوهای رایج و ضعیف.
- **پیشنهاد رمز عبور قوی**: تولید خودکار رمزهای عبور امن بر اساس ترجیحات کاربر.

### 6.2. بهبود UX
- **ذخیره‌ی پیش‌نویس**: ذخیره‌ی رمز عبور وارد‌شده برای جلوگیری از تایپ مجدد در صورت خطا.
- **راهنمای تصویری**: نمایش نمودارهای قدرت رمز عبور به صورت بصری.
- **پشتیبانی از رمز عبور عبور**: امکان استفاده از رمزهای عبور چندکلمه‌ای (Passphrases).

### 6.3. یکپارچه‌سازی‌های پیشرفته
- **اتصال به Have I Been Pwned**: بررسی رمز عبور جدید در لیست رمزهای عبور لو رفته.
- **Webhook**: اطلاع‌رسانی به تیم امنیتی در صورت تلاش برای استفاده از توکن‌های نامعتبر.
- **OAuth**: امکان ورود با رمز عبور یکبار مصرف از طریق اپلیکیشن‌های احراز هویت.

---

## ✅ خلاصه نهایی

صفحه `reset-password.html` باید **امن، کاربرپسند و مقاوم در برابر حملات** باشد. با ترکیب **اعتبارسنجی‌های پیشرفته** (توکن، قدرت رمز عبور)، **محدودیت‌های درخواست** و **طراحی UX تمیز**، می‌توانیم اطمینان حاصل کنیم که کاربران به راحتی و ایمنی رمز عبور خود را بازیابی کنند.

---

## 🎯 گام بعدی

**آیا تحلیل فوق برای شما کافی است؟**  
اگر بله — **لطفاً تأیید کنید** تا صفحه `reset-password.html` را با تمام ویژگی‌های ذکر شده پیاده‌سازی کنم! 🚀


✅ نکات کلیدی پیاده‌سازی:
1. هدر و فوتر:
text

*   هدر شامل لوگو و لینک بازگشت به صفحه ورود.  
*   فوتر ساده شامل اطلاعات حقوقی.
2. فرم اصلی:
text

*   فیلدهای **رمز عبور جدید** و **تأیید رمز عبور** با قابلیت نمایش/پنهان کردن (آیکون چشم).
*   **اندیکاتور قدرت رمز عبور**: نمایش بصری قدرت رمز هنگام تایپ.
- **اعتبارسنجی سمت کلاینت**: بررسی انطباق رمزها و حداقل طول رمز عبور.
- **فیلد توکن مخفی**: `resetTokenInput` که مقدار خود را از URL می‌گیرد (در نسخه واقعی، این توکن از API سرور دریافت می‌شود).
3. پیام‌های وضعیت:
text

*   نمایش پیام‌های موفقیت (`alert-success`) یا خطا (`alert-danger`) بر اساس پاسخ سرور.
4. امنیت:
text

*   `autocomplete="new-password"` برای فیلدهای رمز عبور.
-  **reCAPTCHA**: (کد آن کامنت شده) در صورت نیاز قابل فعال‌سازی است.
5. استایل‌دهی:
text

*   استفاده از CSS سفارشی برای ظاهر مدرن و هماهنگ با پروژه.
- **انیمیشن AOS**: برای جلوه‌های بصری هنگام بارگذاری صفحه.
🔗 نحوه اتصال و کارکرد
دریافت توکن:
لینک بازیابی که به کاربر ایمیل می‌شود، حاوی توکن است: https://psyclinic.ir/reset-password.html?token=UNIQUE_RESET_TOKEN
نمایش صفحه: هنگامی که صفحه reset-password.html بارگذاری می‌شود، جاوااسکریپت (DOMContentLoaded) پارامتر token را از URL استخراج می‌کند.
اعتبارسنجی توکن: (در بک‌اند) این توکن با توکن‌های معتبر ذخیره شده در دیتابیس مقایسه می‌شود. اگر معتبر بود، فرم فعال می‌شود. (در این کد، یک توکن شبیه‌سازی شده simulatedValidToken وجود دارد).
ورود داده‌ها: کاربر رمز عبور جدید را تایپ می‌کند.
اعتبارسنجی ورودی: جاوااسکریپت تطابق رمز عبور و قدرت آن را چک می‌کند.
ارسال به سرور: در صورت معتبر بودن، فرم (شامل توکن و رمز عبور جدید) به API سرور ارسال می‌شود.
نتیجه: نمایش پیام موفقیت یا خطا.
این فایل HTML/CSS/JS یک نمای کلی و کارآمد از صفحه بازیابی رمز عبور را پیاده‌سازی می‌کند.

اگر نیاز به پیاده‌سازی بک‌اند، API، یا پیچیدگی‌های امنیتی بیشتر (مانند reCAPTCHA فعال) دارید، لطفاً بفرمایید تا مراحل بعدی را برایتان توضیح دهم.