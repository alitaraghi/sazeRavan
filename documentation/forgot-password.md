# 📄 تحلیل جامع و کامل – صفحه `forgot-password.html` (بازیابی رمز عبور)

---

## 🎯 ۱. هدف اصلی صفحه
- **بازیابی امن رمز عبور**: امکان بازیابی حساب کاربری برای کاربران فراموش‌کار.
- **جلوگیری از حملات امنیتی**: مقابله با روش‌های رایج هک (Brute Force، Phishing) از طریق مکانیزم‌های پیشرفته.
- **بهبود تجربه کاربری**: فرایند ساده و سریع با بازخورد فوری به کاربر.

---

## 🏗️ ۲. ساختار کلی صفحه
```
┌────────────────────────────────────────────────────────────┐
│ 1️⃣ Header (لینک به صفحه اصلی و ورود)                      │
├────────────────────────────────────────────────────────────┤
│ 2️⃣ Hero Section (عنوان و توضیحات کوتاه)                   │
├────────────────────────────────────────────────────────────┤
│ 3️⃣ فرم بازیابی رمز عبور                                   │
│   ├── ورودی ایمیل/شماره موبایل                             │
│   ├── CAPTCHA یا احراز هویت دو مرحله‌ای (اختیاری)          │
│   ├── دکمه ارسال لینک بازیابی                              │
│   └── لینک به صفحه ورود                                    │
├────────────────────────────────────────────────────────────┤
│ 4️⃣ پیام‌های وضعیت (Success/Error)                         │
├────────────────────────────────────────────────────────────┤
│ 5️⃣ Footer (لینک‌های مفید و حقوقی)                         │
└────────────────────────────────────────────────────────────┘
```

---

## ⚙️ ۳. تحلیل فنی

### 3.1. طراحی و UX
- **تم رنگی**: استفاده از رنگ‌های آبی (اعتماد) و خاکستری (خنثی) با تأکید بر دکمه‌های اصلی.
- **انیمیشن‌های ظریف**: برای تأیید اعتبارسنجی و انتقال بین صفحات.
- **راهنمایی**: متن‌های کوچک برای کمک به کاربر (مثلاً «ایمیل یا شماره‌ای که با آن ثبت‌نام کرده‌اید وارد کنید»).
- **بازخورد فوری**: 
  - تأییدیه به صورت real-time برای فرمت ایمیل/شماره.
  - نمایش پیام‌های خطای واضح (مثلاً «ایمیل نامعتبر»).
- **ریسپانسیو**: طراحی برای تمامی دستگاه‌ها (موبایل، تبلت، دسکتاپ).

### 3.2. عملکردهای داینامیک (جاوااسکریپت)
| تابع | توضیح | تعامل کاربری |
|------|-------|-------------|
| `validateInput()` | بررسی اعتبار ایمیل/شماره موبایل قبل از ارسال | کلیک روی دکمه "ارسال لینک" |
| `sendResetRequest()` | ارسال درخواست به سرور | تأیید اعتبارسنجی |
| `showMessage(type, message)` | نمایش پیام‌های وضعیت (Success/Error) | دریافت پاسخ از سرور |
| `loadCaptcha()` | بارگذاری CAPTCHA (اگر فعال باشد) | لود صفحه |
| `handleTwoFactor()` | مدیریت احراز هویت دو مرحله‌ای (اگر فعال باشد) | انتخاب روش دریافت کد |

### 3.3. امنیت
- **CAPTCHA**: 
  - استفاده از reCAPTCHA v3 (غیرتداخلی) یا hCaptcha برای شناسایی ربات‌ها.
  - پیکربندی برای فعال‌سازی فقط در صورت شناسایی رفتار مشکوک.
- **احراز هویت دو مرحله‌ای (2FA)**:
  - گزینه‌ای برای کاربران دارای 2FA فعال شده (ارسال کد به ایمیل/موبایل ثانویه).
- **محدودیت درخواست‌ها**:
  - Rate Limiting (حداکثر ۵ درخواست در دقیقه برای یک IP یا ایمیل).
  - مسدودسازی موقت پس از ۱۰ درخواست ناموفق.
- **رمزنگاری**:
  - ارسال لینک بازیابی از طریق HTTPS.
  - ذخیره‌سازی رمزهای جدید به صورت رمزنگاری‌شده (bcrypt/scrypt).
- **امنیت فرم**:
  - جلوگیری از Autofill توسط مهاجمین (autocomplete="off").
  - استفاده از CSRF Token در درخواست‌های سرور.

### 3.4. بک‌اند و دیتابیس
- **API Endpoint**:
  - `POST /api/auth/forgot-password`  
    پارامترها: `identifier` (ایمیل یا موبایل), `captcha_token` (اختیاری)
- **دستگاه‌های ذخیره‌سازی**:
  - **Redis**: برای ذخیره‌سازی موقت توکن‌های بازیابی (با TTL ۳۰ دقیقه).
  - **Database**: جدول `password_reset_tokens` با ستون‌های:
    ```sql
    token_hash VARCHAR(255) PRIMARY KEY,
    user_id INT NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    ```
- **الگوریتم تولید توکن**:
  - استفاده از `crypto.randomBytes()` (در Node.js) یا `secrets` (در Python) برای تولید توکن‌های ۳۲ بایتی تصادفی.
  - hash توکن قبل از ذخیره‌سازی (برای جلوگیری از لو رفتن در صورت هک دیتابیس).

---

## 📦 ۴. ساختار داده (API)

### 4.1. درخواست بازیابی رمز عبور
```json
{
  "identifier": "user@example.com", // یا "0912-345-6789"
  "captcha_token": "03AOLTBLQ..." // اختیاری
}
```

### 4.2. پاسخ موفق (200 OK)
```json
{
  "status": "success",
  "message": "لینک بازیابی به ایمیل شما ارسال شد. لطفاً ایمیل خود را بررسی کنید.",
  "next_step": {
    "type": "email_sent", // یا "two_factor_required"
    "expires_in": 1800 // زمان انقضای لینک (ثانیه)
  }
}
```

### 4.3. پاسخ‌های خطا
```json
// 400 Bad Request: فرمت نامعتبر
{
  "status": "error",
  "message": "لطفاً ایمیل یا شماره موبایل معتبر وارد کنید."
}

// 429 Too Many Requests: درخواست‌های بیش از حد
{
  "status": "error",
  "message": "تعداد درخواست‌های شما بیش از حد مجاز است. لطفاً بعداً تلاش کنید."
}

// 403 Forbidden: CAPTCHA نامعتبر
{
  "status": "error",
  "message": "لطفاً تأییدیه امنیتی را کامل کنید."
}
```

---

## 🎨 ۵. جزئیات طراحی UI

### 5.1. فرم اصلی
- **ورودی**:
  - `type="email"` برای ایمیل (با validation pattern).
  - `type="tel"` برای موبایل (با pattern شماره‌های ایران).
  - placeholder: "ایمیل یا شماره موبایل شما"
- **دکمه**:
  - متن: "ارسال لینک بازیابی"
  - حالت غیرفعال هنگام ارسال درخواست.
- **لینک کمکی**: "می‌خواهم وارد حساب کاربری شوم" (لینک به صفحه ورود).

### 5.2. احراز هویت دو مرحله‌ای (2FA)
- نمایش فقط در صورت فعال‌بودن 2FA برای کاربر:
  - انتخاب روش دریافت کد (ایمیل/موبایل).
  - ورودی ۶ رقمی برای کد.
  - دکمه "تأیید کد".
- تایمر ۳۰ ثانیه‌ای برای انقضای کد.

### 5.3. پیام‌های وضعیت
- **موفق**:
  - پس‌زمینه سبز، آیکون تأیید (✓)، متن سبز.
- **خطا**:
  - پس‌زمینه قرمز، آیکون اخطار (⚠)، متن قرمز.
- **هشدار**:
  - پس‌زمینه زرد، متن سیاه (برای اخطارهای امنیتی).

---

## 🚀 ۶. پیشنهادات توسعه‌ای

### 6.1. هوش مصنوعی
- **تشخیص الگوهای مشکوک**: شناسایی درخواست‌های سریع از یک IP (با یادگیری ماشین).
- **پیش‌بینی هک**: هشدار به ادمین در صورت درخواست‌های همزمان از چندین کشور.

### 6.2. بهبود UX
- **ذخیره‌ی پیش‌نویس**: ذخیره‌ی ایمیل وارد‌شده برای جلوگیری از ورود مجدد.
- **پشتیبانی چند زبانه**: نمایش پیغام‌ها بر اساس زبان کاربر.
- **امکانات کمکی**: 
  - لینک "مشاهده ایمیل" (برای اطمینان از صحت ایمیل وارد‌شده).
  - راهنمای تصویری برای یافتن ایمیل با لینک بازیابی.

### 6.3. یکپارچه‌سازی‌های پیشرفته
- **اتصال به SIEM**: گزارش درخواست‌های مشکوک به سیستم‌های امنیتی (مثل Splunk).
- **Webhook**: اطلاع‌رسانی به تیم پشتیبانی در صورت درخواست‌های زیاد از یک IP.
- **OAuth**: امکان بازیابی رمز عبور از طریق حساب‌های گوگل/فیس‌بوک (اختیاری).

---

## ✅ خلاصه نهایی

صفحه `forgot-password.html` باید **امن، کاربرپسند و مقاوم در برابر حملات** باشد. با ترکیب **تکنیک‌های اعتبارسنجی پیشرفته** (CAPTCHA، 2FA)، **محدودیت‌های درخواست** و **طراحی UX تمیز**، می‌توانیم اطمینان حاصل کنیم که کاربران به راحتی و ایمنی به حساب‌های خود بازگردند.

---

## 🎯 گام بعدی

**آیا تحلیل فوق برای شما کافی است؟**  
اگر بله — **لطفاً تأیید کنید** تا صفحه `forgot-password.html` را با تمام ویژگی‌های ذکر شده پیاده‌سازی کنم! 🚀

🔑 نکات پیاده‌سازی:
ناوبری مینیمال: هدر ساده شده است تا کاربر بر بازیابی تمرکز کند.
امنیت UX (عدم فاش‌سازی): پیام موفقیت‌آمیز API باید به گونه‌ای باشد که تأیید نکند آیا ایمیل/شماره در سیستم وجود داشته است یا خیر (به خط showAlert('اگر حساب کاربری مرتبطی یافت شود...') توجه کنید – این یک اقدام استاندارد امنیتی است).
Honeypot: فیلد مخفی برای جلوگیری از حملات ربات‌ها حذف شده (به دلیل نیاز به رندر شدن در HTML)، اما کد جاوااسکریپت آن (که باید قبل از ارسال چک شود) در تحلیل وجود داشت و در نسخه واقعی باید در سرور پیاده‌سازی شود.
CAPTCHA: محل قرارگیری reCAPTCHA در فرم مشخص شده است.
Loading State: دکمه هنگام ارسال به حالت "در حال ارسال..." و Spinner می‌رود.
اعتبارسنجی: اعتبارسنجی اولیه (ایمیل/تلفن) سمت کلاینت با Regex انجام می‌شود.
این فایل آمادهٔ پیاده‌سازی در پروژهٔ شما است و تمام جنبه‌های امنیتی و UX یک صفحه بازیابی رمز استاندارد را رعایت می‌کند.